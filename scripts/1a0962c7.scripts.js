"use strict";var app=angular.module("angNewsApp",["ngCookies","ngResource","ngSanitize","ngRoute","firebase"]).constant("FIREBASE_URL","https://amber-fire-2904.firebaseio.com/");app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/posts.html",controller:"PostsController"}).when("/posts/:postId",{templateUrl:"views/showpost.html",controller:"PostViewController"}).when("/register",{templateUrl:"views/register.html",controller:"AuthController"}).when("/login",{templateUrl:"views/login.html",controller:"AuthController"}).when("/users/:username",{templateUrl:"views/profile.html",controller:"ProfileController"}).otherwise({redirectTo:"/"})}]),app.controller("PostsController",["$scope","$location","Post",function(a,b,c){"/"===b.path()&&(a.posts=c.all),a.deletePost=function(a){c.delete(a)},a.upVotePost=function(a,b){b?c.clearVote(a,b):c.upVote(a)},a.downVotePost=function(a,b){b?c.clearVote(a,!b):c.downVote(a)},a.upVoted=function(a){return c.upVoted(a)},a.downVoted=function(a){return c.downVoted(a)}}]),app.controller("PostViewController",["$scope","$routeParams","Post",function(a,b,c){a.post=c.find(b.postId),a.addComment=function(){c.addComment(b.postId,a.comment),a.comment=""},a.removeComment=function(b,d){c.deleteComment(a.post,b,d)},a.upVotePost=function(a){a?c.clearVote(b.postId,!0):c.upVote(b.postId)},a.downVotePost=function(a){a?c.clearVote(b.postId,!1):c.downVote(b.postId)},a.upVoted=function(){return c.upVoted(a.post)},a.downVoted=function(){return c.downVoted(a.post)}}]),app.controller("NavController",["$scope","$location","Post","Auth",function(a,b,c,d){a.post={url:"http://",title:""},a.submitPost=function(){c.create(a.post).then(function(c){a.post={url:"http://",title:""},b.path("/posts/"+c)})},a.logout=function(){d.logout()}}]),app.factory("Post",["$firebase","FIREBASE_URL","User",function(a,b,c){var d=new Firebase(b+"posts"),e=a(d),f={all:e,create:function(a){if(c.signedIn()){var b=c.getCurrent();return a.owner=b.username,e.$add(a).then(function(a){var c=a.name();return b.$child("posts").$child(c).$set(c),c})}},find:function(a){return e.$child(a)},"delete":function(a){if(c.signedIn()){var b=f.find(a);b.$on("loaded",function(){var d=c.findByUsername(b.owner);e.$remove(a).then(function(){d.$child("posts").$remove(a)})})}},addComment:function(a,b){if(c.signedIn()){var d=c.getCurrent();b.username=d.username,b.postId=a,e.$child(a).$child("comments").$add(b).then(function(b){d.$child("comments").$child(b.name()).$set({id:b.name(),postId:a})})}},deleteComment:function(a,b,d){if(c.signedIn()){var e=c.findByUsername(b.username);a.$child("comments").$remove(d).then(function(){e.$child("comments").$remove(d)})}},upVote:function(a){if(c.signedIn()){var b=c.getCurrent(),d=e.$child(a);d.$child("upvotes").$child(b.username).$set(b.username).then(function(){b.$child("upvotes").$child(a).$set(a),d.$child("downvotes").$remove(b.username),b.$child("downvotes").$remove(a),d.$child("score").$transaction(function(a){return a?a+1:1})})}},downVote:function(a){if(c.signedIn()){var b=c.getCurrent(),d=e.$child(a);d.$child("downvotes").$child(b.username).$set(b.username).then(function(){b.$child("downvotes").$child(a).$set(a),d.$child("upvotes").$remove(b.username),b.$child("upvotes").$remove(a),d.$child("score").$transaction(function(a){return void 0===a||null===a?-1:a-1})})}},clearVote:function(a,b){if(c.signedIn()){var d=c.getCurrent(),f=d.username,g=e.$child(a);g.$child("upvotes").$remove(f),g.$child("downvotes").$remove(f),d.$child("upvotes").$remove(a),d.$child("downvotes").$remove(a),g.$child("score").$transaction(function(a){return b?a-1:a+1})}},upVoted:function(a){return c.signedIn()&&a.upvotes?a.upvotes.hasOwnProperty(c.getCurrent().username):void 0},downVoted:function(a){return c.signedIn()&&a.downvotes?a.downvotes.hasOwnProperty(c.getCurrent().username):void 0}};return f}]),app.filter("hostnameFromUrl",function(){return function(a){var b=document.createElement("a");return b.href=a,b.hostname}}),app.controller("AuthController",["$scope","$location","Auth","User",function(a,b,c,d){c.signedIn()&&b.path("/"),a.$on("$firebaseSimpleLogin:login",function(){b.path("/")}),a.login=function(){c.login(a.user).then(function(){b.path("/")},function(b){a.error=b.toString()})},a.register=function(){c.register(a.user).then(function(c){d.create(c,a.user.username),b.path("/")},function(b){a.error=b.toString()})}}]),app.factory("Auth",["$firebaseSimpleLogin","FIREBASE_URL","$rootScope",function(a,b,c){var d=new Firebase(b),e=a(d),f={register:function(a){return e.$createUser(a.email,a.password)},signedIn:function(){return null!==e.user},login:function(a){return e.$login("password",a)},logout:function(){e.$logout()}};return c.signedIn=function(){return f.signedIn()},f}]),app.factory("User",["$firebase","FIREBASE_URL","Auth","$rootScope",function(a,b,c,d){function e(a){d.currentUser=h.findByUsername(a)}var f=new Firebase(b+"users"),g=a(f),h={create:function(a,b){g[b]={md5_hash:a.md5_hash,username:b,$priority:a.uid},g.$save(b).then(function(){e(b)})},findByUsername:function(a){return a?g.$child(a):void 0},getCurrent:function(){return d.currentUser},signedIn:function(){return void 0!==d.currentUser}};return d.$on("$firebaseSimpleLogin:login",function(b,c){var d=a(f.startAt(c.uid).endAt(c.uid));d.$on("loaded",function(){e(d.$getIndex()[0])})}),d.$on("$firebaseSimpleLogin:logout",function(){delete d.currentUser}),h}]),app.controller("ProfileController",["$scope","$routeParams","Post","User",function(a,b,c,d){function e(){a.posts={},angular.forEach(a.user.posts,function(b){a.posts[b]=c.find(b)})}function f(){a.comments={},angular.forEach(a.user.comments,function(b){var d=c.find(b.postId);d.$on("loaded",function(){a.comments[b.id]=d.$child("comments").$child(b.id),a.commentedPosts[b.postId]=d})})}a.user=d.findByUsername(b.username),a.commentedPosts={},a.user.$on("loaded",function(){e(),f()})}]),app.directive("checkUsername",["User",function(a){var b=/^[^.$\[\]#\/\s]+$/;return{require:"ngModel",link:function(c,d,e,f){f.$parsers.unshift(function(c){return b.test(c)?0===a.findByUsername(c).$getIndex().length?(f.$setValidity("taken",!0),f.$setValidity("invalid",!0),c):(f.$setValidity("taken",!1),void f.$setValidity("invalid",!0)):(f.$setValidity("taken",!0),void f.$setValidity("invalid",!1))})}}}]);